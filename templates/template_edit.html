{% extends "base.html" %}

{% block content %}

<div class="space-y-6">

    <!-- Header -->
    <div class="flex items-center justify-between">

        <div>
            <h2 class="text-2xl font-semibold text-gray-800">
                Editar Template
            </h2>

            <p class="text-sm text-gray-500 mt-1 font-mono">
                {{ name }}
            </p>
        </div>

        <div class="flex gap-2">

            <a href="/templates"
               class="px-4 py-2 text-sm border rounded-lg hover:bg-gray-50 transition">
                Voltar
            </a>

            <button form="editor-form"
                    type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white
                           px-4 py-2 rounded-lg shadow-sm transition">
                Salvar
            </button>

        </div>

    </div>


    <!-- Editor container -->
    <form method="post"
          id="editor-form"
          onsubmit="saveEditor()"
          class="space-y-4">

        <div class="border rounded-xl overflow-hidden shadow-sm">

            <!-- Editor toolbar -->
            <div class="bg-gray-50 border-b px-4 py-2 flex items-center justify-between">

                <div class="text-sm text-gray-600">
                    Monaco Editor
                </div>

                <div class="text-xs text-gray-400 font-mono">
                    {{ name }}
                </div>

            </div>

            <!-- Monaco editor -->
            <div id="editor" class="h-[600px]"></div>

        </div>

        <textarea name="content" id="content" hidden></textarea>

    </form>

</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

<script>

function detectLanguage(filename) {

    filename = filename.toLowerCase()

    if (filename.endsWith(".php") || filename.endsWith(".php.jinja"))
        return "php"

    if (filename.endsWith(".html") || filename.endsWith(".html.jinja"))
        return "html"

    if (filename.endsWith(".js") || filename.endsWith(".js.jinja"))
        return "javascript"

    if (filename.endsWith(".css") || filename.endsWith(".css.jinja"))
        return "css"

    if (filename.endsWith(".py") || filename.endsWith(".py.jinja"))
        return "python"

    if (filename.endsWith(".sql") || filename.endsWith(".sql.jinja"))
        return "sql"

    return "plaintext"
}

require.config({
    paths: {
        vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs'
    }
});

let editor;

require(["vs/editor/editor.main"], function () {

    const language = detectLanguage("{{ name }}");

    editor = monaco.editor.create(document.getElementById('editor'), {

        value: {{ content|tojson }},

        language: language,

        theme: "vs-dark",

        automaticLayout: true,

        fontSize: 14,

        lineHeight: 20,

        padding: {
            top: 12
        },

        roundedSelection: true,

        scrollBeyondLastLine: false,

        minimap: {
            enabled: false
        }

    });

    registerJinjaAutocomplete(language);

});


function saveEditor() {

    document.getElementById("content").value =
        editor.getValue();

}


function registerJinjaAutocomplete(language) {

    monaco.languages.registerCompletionItemProvider(language, {

        triggerCharacters: ["{", ".", " "],

        provideCompletionItems: function (model, position) {

            const word = model.getWordUntilPosition(position);

            const range = {
                startLineNumber: position.lineNumber,
                endLineNumber: position.lineNumber,
                startColumn: word.startColumn,
                endColumn: word.endColumn
            };

            return {
                suggestions: [

                    {
                        label: "table",
                        kind: monaco.languages.CompletionItemKind.Variable,
                        insertText: "table",
                        range: range
                    },

                    {
                        label: "columns",
                        kind: monaco.languages.CompletionItemKind.Variable,
                        insertText: "columns",
                        range: range
                    },

                    {
                        label: "for column in columns",
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText:
`{% raw %}{% for column in columns %}
    {{ column.name }}
{% endfor %}{% endraw %}`,
                        insertTextRules:
                            monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        range: range
                    },

                    {
                        label: "column.name",
                        kind: monaco.languages.CompletionItemKind.Field,
                        insertText: "column.name",
                        range: range
                    },

                    {
                        label: "column.type",
                        kind: monaco.languages.CompletionItemKind.Field,
                        insertText: "column.type",
                        range: range
                    },

                    {
                        label: "column.notnull",
                        kind: monaco.languages.CompletionItemKind.Field,
                        insertText: "column.notnull",
                        range: range
                    },

                    {
                        label: "column.pk",
                        kind: monaco.languages.CompletionItemKind.Field,
                        insertText: "column.pk",
                        range: range
                    },

                    {
                        label: "if",
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText:
`{% raw %}{% if condition %}
    
{% endif %}{% endraw %}`,
                        insertTextRules:
                            monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        range: range
                    },

                    {
                        label: "jinja variable",
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: "{% raw %}{{ ${1:variable} }}{% endraw %}",
                        insertTextRules:
                            monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        range: range
                    }

                ]
            };

        }

    });

}

</script>

{% endblock %}